<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensors (Basic)</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sen:wght@400..800&display=swap" rel="stylesheet">
  </head>
  <body>
    <ul>
      <li id="gyroscope-x"></li>
      <li id="gyroscope-y"></li>
      <li id="gyroscope-z"></li>
    </ul>
    <ul>
      <li id="acceleration-x"></li>
      <li id="acceleration-y"></li>
      <li id="acceleration-z"></li>
    </ul>
    <script nonce="{{ csp_nonce }}">
      const urlParams = new URLSearchParams(window.location.search);
      const ipAddress = urlParams.get('ip');

      var ws;

      if (ipAddress === null) {
        alert("The Godot process's IP address was not provided in URL param!");
      } else {
        ws = new WebSocket(`wss://${ipAddress}:9080`);
        console.log(`[WebSocket] Attempted to establish WebSocket connection; IP address = ${ipAddress}`);

        ws.onopen = () => {
          console.log("[WebSocket] Connected!");
          ws.send("Hello from web app!");
        };

        ws.onmessage = (event) => {
          console.log("[WebSocket] Web app received: ", event.data);
        };

        // I - Gyroscope
        if (typeof Gyroscope === "undefined") {
          alert("Gyroscope API not supported on this device/browser.")
        }
        else {
          const gyroscope = new Gyroscope({ frequency: 60 });

          const gyroscopeLabelX = document.querySelector("#gyroscope-x");
          const gyroscopeLabelY = document.querySelector("#gyroscope-y");
          const gyroscopeLabelZ = document.querySelector("#gyroscope-z");

          gyroscope.addEventListener("reading", (e) => {
            gyroscopeLabelX.innerText = `Angular velocity along the X-axis = ${gyroscope.x}`;
            gyroscopeLabelY.innerText = `Angular velocity along the Y-axis = ${gyroscope.y}`;
            gyroscopeLabelZ.innerText = `Angular velocity along the Z-axis = ${gyroscope.z}`;
            ws.send(`{"X": ${gyroscope.x}, "Y": ${gyroscope.y}, "Z": ${gyroscope.z}}`)
          });

          gyroscope.start();
        }

        // II - Acceleration
        if (typeof LinearAccelerationSensor === "undefined") {
          alert("LinearAccelerationSensor API not supported on this device/browser.")
        }
        else {
          const acceleration = new LinearAccelerationSensor({ frequency: 60 });

          const accelerationLabelX = document.querySelector("#acceleration-x");
          const accelerationLabelY = document.querySelector("#acceleration-y");
          const accelerationLabelZ = document.querySelector("#acceleration-z");

          acceleration.addEventListener("reading", (e) => {
            accelerationLabelX.innerText = `Acceleration along the X-axis = ${acceleration.x}`;
            accelerationLabelY.innerText = `Acceleration along the Y-axis = ${acceleration.y}`;
            accelerationLabelZ.innerText = `Acceleration along the Z-axis = ${acceleration.z}`;
            ws.send(`{"X": ${acceleration.x}, "Y": ${acceleration.y}, "Z": ${acceleration.z}}`)
          });

          acceleration.start();
        }
      }
    </script>
  </body>
</html>